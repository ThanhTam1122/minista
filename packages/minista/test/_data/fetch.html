<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
  </head>
  <body>
    <h1>minista v3 開発メモ</h1>
    <!-- prettier-ignore -->
    <div data-minista-compile-target="markdown">## 概要
      v3メジャーアップデートでは主に開発環境の改新とコード全体の見直しを中心に行う。~~ユーザー側の新機能はなく~~アップグレードは容易。開発モードが本番に近づくことがメリット。
      v1（webpackベース）からv2（Vite &amp; esbuildベース）への切り替えは上手くいった。Next.jsやAstroにある取り入れたい機能もおおむね実装できた。静的サイトは十分作れる。
      目下の課題はSaaSの改修や試作のデモを作る場合で、既存のjQueryやAlpine.jsを絡めたときにSPAな開発モードだと動かしにくい。SSGな本番とDOMレンダーの仕組みが違うから。パフォーマンスを維持しつつ開発と本番の差異を無くさないと今後の仕事が辛くなるので取り組む。
      しばらくは未確定の実装を色々試すので非公開で開発し、ある程度使える目処が立ったらv3ブランチに乗せる。その後はalpha版を更新しつつ完成させていく。
      ## 実装
      - [ ] 開発環境の改新
      - [x] モノレポ環境の構築
      - [ ] ドキュメントサイトのコードを内包
      - [ ] コード全体の見直し
      - [x] 依存ライブラリを整理
      - [x] Viteをv3にアップグレード
      - [x] React v18に対応
      - [x] react-helmetをreact-helmet-asyncに変更
      - [x] ユニットテスト・E2Eテストを細分化
      - [x] Windowsの検証をParallels Desktopに変更
      - [x] コンフィグ解決を再設計
      - [x] プロジェクトroot変更機能を追加
      - [x] v2 RootをGlobalに名称変更
      - [x] v2 RootとPagesのオプションを削除
      - [x] esbuildの内部処理の大部分をViteに変更
      - [x] 本番に近い開発モードを実装
      - [x] 非同期関数getStaticDataの再設計
      - [x] MDX 2周りの再設計
      - [ ] エントリーアセットの再設計
      - [ ] バンドルアセットの再設計
      - [x] SVGコンポーネントの再設計
      - [ ] スプライトアイコンの再設計
      - [ ] 画像ダウンロードの再設計
      - [ ] Partial Hydrationの再設計
      - [ ] 全文検索機能の再設計
      - [x] Headコンポーネントの再設計
      - [x] Commentコンポーネントの再設計
      - [ ] Markdownコンポーネントを実装
      - [ ] preview-mapを実装（旧sitemap）
      - [ ] create-ministaの再設計
      ### モノレポ環境の構築
      有名なフレームワークのリポジトリはほとんどモノレポ構成なので、メリットが大きいのであれば採用しようと考えていた。どうやらpackagesにエイリアスでアクセスできるらしい。今まで相対パスの問題（？）で `preact/compat` を絡めたビルドがコケてたけど改善できるかも。
      ツールはnpmにデフォルトでモノレポ機能があり、それを使うのが良さそう。独自ツールは古くなった時に依存してると辛いし。共通のビルドスクリプトは自分で書く。
      pnpm導入は保留。Netlifyなどの対応が不十分。各所でビルドがこけると面倒。package.jsonのモジュールしか読み込めない仕様は良いと思う。パスはpnpm想定で今から厳格にしておく。
      ### ドキュメントサイトのコードを内包
      GitHub Pagesの公開が柔軟になったらしく、公開サイトのTTFB（日本）もFirebase Hosting並みに早かったのでリポジトリへの内包を検討。昔はビルドプロセスが見れなくてストレスでやめた。中に置いておけば、誤字のプルリクとか出してもらいやすくなるし無駄がない。
      ### 依存ライブラリを整理
      ministaとcreate-ministaで似た機能の異なるモジュールを使っているので統一する。メンテ状況や利用数を考慮しつつ、使い勝手の良いものを選ぶ。
      モジュールの導入を最低限にできているか再検証する。例えば、esbuildがTSConfigのJSX設定を読んでimport文を自動挿入してくれるようになったので、ラッパーのtsupは省ける。
      ### Viteをv3にアップグレード
      特に問題なくアップグレード。glob importにignoreが使えるようになり助かった。
      ### React v18に対応
      v17以前のハイブリッド対応に悩んでいたが、後述する開発モードの作り直しで差異のあるAPIを使わなくなったので、対応の必要がなくなった。あとはPartial Hydrationの再設計次第。
      ### react-helmetをreact-helmet-asyncに変更
      react-helmetの開発が止まっており、React v18で生じた問題を解決しにくいことや、スレッドセーフにならない部分がありreact-helmet-asyncへの移行を考えていた。
      ### ユニットテスト・E2Eテストを細分化
      ユニットテストはある程度行っていたが、細かくテストし直すとバグがあった。ビルドはコードが膨らみ密結合となってしまったので分解してテストする。E2Eも条件ごとに細分化。
      ### Windowsの検証をParallels Desktopに変更
      開発はMacメインで、実機Winによる検証は効率が悪かった。M1にして使っていなかったParallels DesktopがWin正規品に対応したので再度契約する予定。
      ### コンフィグ解決を再設計
      後からCLIオプションを追加したり、そのほかの実装が膨らんだのもあり、コンフィグ周りが煩雑になってしまった。マージの仕組みを見直してCLIオプションも渡しやすくする。
      ### プロジェクトroot変更機能を追加
      プロジェクトrootを変更できるとE2Eテストの細分化で役立つ。Viteの仕様に準じる。
      ### v2 RootをGlobalに名称変更
      プロジェクトroot変更機能を追加したことにより、既存のRootコンポーネントと名称が被り紛らわしくなった。そのため、今後はv2のRoot機能をGlobalとする。後方互換あり。Viteのglob importにignoreオプションが追加されたため `pages/_global.tsx` なども可能となった。
      ### v2 RootとPagesのオプションを削除
      v2 RootとPagesは `@rollup/plugin-dynamic-import-vars` の制約でimport文に変数が使えず、一時ファイルを作成して処理を行なっていた。プロジェクトroot変更機能を追加したことでv2 RootとPagesの場所もある程度変えられるため、内部処理の簡易化を優先して削除する。
      ### esbuildの内部処理の大部分をViteに変更
      v2ではSSGをesbuildが行い、開発モードとアセットビルドをViteで処理していた。そのため、機能追加の度に両方の処理を書く必要があり悩みの種だった。特にesbuildはViteと違ってCJSとESMをよしなに処理してくれないため手間がかかる。
      プラグインによる機能追加もMDX以外は非現実的だった。Viteはプラグイン開発が活発なものの、esbuildの方はそうでもない。また、v2ではesbuildのプラグイン追加機能を提供していない。拡張のために作者の異なるプラグインを設定してほしくなかったから。
      v3を機にesbuildの内部処理の大部分をViteで行えないか検証する。重要だったSSGをViteで行えたのでほぼ成功。一時ファイルも必要なくなった。プラグインも導入しやすくなるだろう。
      ### 本番に近い開発モードを実装
      minista v2はNext.jsの開発環境を目指していたため、Viteの剥き出しなindex.htmlと相性が悪かった。そこはなんとかVitePressなどの実装を参考に解決したが、開発モードがSPAであることは変わらず、冒頭のJSデバッグ問題が大きくなった。
      v3で本番に近づけるため、SSRに目をつけた。普通はReactから静的HTMLとJSを生成してハイドレーションするが、ハイドレーションせずに静的HTMLだけ開発サーバーに返せばSSGに近い。この状態をベースにアセットの読み込みを最適化すれば理想に近づきそう。
      ### 非同期関数getStaticDataの再設計
      処理が複雑だったのでデバッグしやすいよう書き直し。fetchの自動import機能をshimを使わず新しくする（node v18以降がスタンダードになったら不要となる）。今後を見据えてnode-fetchをundiciのfetchに差し替え。
      ### MDX 2周りの再設計
      コンフィグを作り直した時点で完成。
      ### エントリーアセットの再設計
      未定
      ### バンドルアセットの再設計
      未定
      ### SVGコンポーネントの再設計
      Viteプラグインのみの実装で完了。
      ### スプライトアイコンの再設計
      未定
      ### 画像ダウンロードの再設計
      未定
      ### Partial Hydrationの再設計
      鬼門。Viteのみでどうやれるか、まだイメージできていない。
      ### 全文検索機能の再設計
      未定。Partial Hydration次第。開発中にメモリ上のみで済ませられると綺麗。
      ### Headコンポーネントの再設計
      react-helmet-asyncに変更して作り直し。typesをちょっと追加した程度で移行完了。
      ### Commentコンポーネントの再設計
      開発中もコメントタグに変換できた。本番を再現。
      ### Markdownコンポーネントを実装
      ministaのMDXコンフィグを反映できるコンパイラーコンポーネント。サーバーサイドで処理してレンダリング前にHTMLを渡す仕様を検討。
      ### preview-mapを実装（旧sitemap）
      未定
      ### create-ministaの再設計
      使うモジュールを見直して作り直す。外部テンプレ利用はdegit使えばいいので不要かも。</div>
  </body>
</html>
